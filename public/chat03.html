<!DOCTYPE html>
<html>
    <head>
        <meta charset = "UTF-8">
        <title>채팅 클라이언트</title>
        <script src="jquery-3.5.1.min.js"></script>
        <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
        
        <script>
            var host;
            var port;
            var socket;
            
            //문서 로딩 후에 실행된다.
            $(function() {
                // 연결하기 버튼을 눌렀을 때 발생하는 이벤트 처리
                $("#connectButton").bind('click', function(event) {
                   println('connectButton 이 클릭되었습니다');
                   
                   host = $('#hostInput').val();
                   port = $('#portInput').val();
                   
                   connectToServer();
                }); 
                // 전송 버튼 클릭했을 때 처리
                $("#sendButton").bind('click', function(event) {
                    console.log(event);
                    
                    var sender = $('#senderInput').val();
                    var recipient = $('#recipientInput').val();
                    var data = $('#dataInput').val();
                    
                    var output = {sender : sender, recipient : recipient, command : 'chat', type : 'text', data : data};
                    console.log('서버로 보낼 데이터 : ' + JSON.stringify(output));
                    
                    if(socket == undefined) {
                        alert('서버에 연결되어있지 않습니다. 먼저 연결하세요');
                        return;
                    }
                    socket.emit('message', output);
                });
                
                // 로그인 버튼을 클릭하면 처리
                $("#loginButton").bind('click', function(event) {
                    var id = $("#idInput").val();
                    var password = $("#passwordInput").val();
                    var alias = $("#aliasInput").val();
                    var today = $("#todayInput").val();
                    
                    var output = {id:id, password:password, alias:alias, today:today};
                    console.log('서버로 보낼 데이터 : ' + output);
                    
                    if(socket == undefined) {
                        alert('서버에 연결되어있지 않습니다. 먼저 연결하세요');
                        return;
                    }
                    
                    socket.emit('login', output);
                });
                
                // 로그아웃 버튼을 클릭하면 처리
                $("#logoutButton").bind('click', function(event) {
                    var id = $("#idInput").val();
                    var password = $("#passwordInput").val();
                    
                    var logout = {id:id, password:password};
                    console.log('서버로 전송할 데이터 : ' + logout);
                    
                    if(socket == undefined) {
                        alert('서버에 연결되어있지 않습니다. 먼저 연결하세요');
                        return;
                    }
                    
                    socket.emit('logout', logout);
                });
                
            });
            
            function connectToServer() {
                var options = {'forceNew' : true};
                var url = 'http://' + host + ':' + port;
                
                // 클라가 socket.io 모듈로 서버에 연결 요청
                socket = io.connect(url, options);
                
                socket.on('connect', function() {
                    var data = " 웹 소켓 서버에 연결됨: " + url;
                    println('<p>' + data + '</p>');
                    
                    // 서버에서 emit한 이벤트가 클라에게 왔을 때, on이벤트 처리를 통해 메시지 수신
                    socket.on('message', function(message) {
                        console.log(JSON.stringify(message));
                        
                        println('<p>수신 메시지 : ' + message.sender + ', ' + message.recipient + ', ' + message.command + ', ' +message.type + ', ' + message.data + '</p>');
                    });
                });
                
                socket.on('disconnect', function() {
                    println('웹 소켓 서버 연결 종료됨');
                });
                
                socket.on('response', function(response) {
                    console.log(JSON.stringify(response));
                    println('응답 메시지를 받았습니다.' + response.command + ', ' + response.code + ', ' +
                           response.message);
                });
                
                socket.on('logout', function(logout) {
                    console.log('로그아웃 응답 메시지 받음');
                    println('로그아웃 응답 메시지를 받았습니다.' + logout.command + ', ' + logout.code + ', ' + logout.message);
                    
                });
            }
            
            function println(data) {
                console.log(data);
                $('#result').append('<p>' + data + '</p>');
            }   
        </script>
        
        
        
    </head>
    <body>
        <h3>채팅 클라이언트 01</h3>
        <br>
        <div>
            <input type="text" id="hostInput" value="localhost">
            <input type="text" id="portInput" value="3701">
            <input type="button" id="connectButton" value="연결하기">
        </div>
        <div>
            <input type="text" id="idInput" value="test01">
            <input type="password" id="passwordInput" value="123456">
            <input type="text" id="aliasInput" value="소녀시대">
            <input type="text" id="todayInput" value="좋은 날!">
            
            <input type="button" id="loginButton" value="로그인">
            <input type="button" id="logoutButton" value="로그아웃">
        </div>
        <div>
            <div>
                <span>보내는 사람 아이디 : </span>
                <input type="text" id="senderInput" value="test01">
            </div>
            <div>
                <span>받는 사람 아이디 : </span>
                <input type="text" id="recipientInput" value="ALL">
            </div>
            <div>
                <span>메시지 데이터 : </span>
                <input type="text" id="dataInput" value="안녕!">
            </div>
            <br>
            <input type="button" id="sendButton" value="전송">
        </div>
        
        <hr/>
        <p>결과 : </p>
        <div id="result"></div>
    </body>
</html>